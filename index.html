<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>stad - AI Quran</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Google Sans', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #131314;
            color: white;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        /* Header */
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem 1.25rem;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            background: #131314;
            z-index: 100;
        }

        .menu-icon {
            cursor: pointer;
            padding: 0.5rem;
        }

        .menu-icon span {
            display: block;
            width: 20px;
            height: 2px;
            background: white;
            margin: 4px 0;
            transition: 0.3s;
        }

        .menu-icon.active span:nth-child(1) {
            transform: rotate(45deg) translate(5px, 5px);
        }

        .menu-icon.active span:nth-child(2) {
            opacity: 0;
        }

        .menu-icon.active span:nth-child(3) {
            transform: rotate(-45deg) translate(7px, -6px);
        }

        .logo {
            font-size: 1.25rem;
            font-weight: 500;
            letter-spacing: 0.5px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .logo-icon {
            color: #4285f4;
        }

        .avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.8rem;
            cursor: pointer;
        }

        /* Main Content */
        .main-content {
            position: relative;
            flex: 1 1;
            display: flex;
            flex-direction: column;
            padding-top: 60px;
            padding-bottom: 140px;
        }

        /* Welcome State */
        .welcome-state {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 2rem;
            transition: opacity 0.3s ease, transform 0.3s ease;
        }

        .welcome-state.hidden {
            opacity: 0;
            transform: translateY(-20px);
            pointer-events: none;
            position: absolute;
        }

        .stad-sparkle {
            width: 48px;
            height: 48px;
            margin-bottom: 1.5rem;
        }

        .welcome-text {
            text-align: center;
            font-size: 100%;
            color: rgba(255,255,255,0.8);
        }

        /* Chat State */
        .chat-container {
            position: relative;
            flex: 1 1;
            padding: 1rem;
            padding-bottom: 2rem;
            display: none;
            flex-direction: column;
            gap: 1.5rem;
            animation: fadeIn 0.5s ease;
            overflow-y: auto; 
            scroll-behavior: smooth;
            scroll-padding-bottom: 120px;
            max-height: calc(100vh - 200px);
        }

        .chat-container.active {
            display: flex;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        /* User Message */
        .user-message {
            align-self: flex-end;
            background: #3c4043;
            padding: 0.75rem 1rem;
            border-radius: 1.25rem;
            max-width: 80%;
            animation: slideInRight 0.4s ease;
        }

        @keyframes slideInRight {
            from {
                opacity: 0;
                transform: translateX(20px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        /* AI Response */
        .ai-response {
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
            animation: fadeInUp 0.5s ease 0.3s both;
        }

        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(15px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .ai-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .ai-star {
            width: 24px;
            height: 24px;
        }

        .sound-icon {
            background:#131314;
            border: none;
            border-radius: 50%;
            cursor: pointer;
            padding: 0.5rem;
            opacity: 0.7;
            transition: opacity 0.2s;
        }

        .sound-icon:hover {
            opacity: 1;
        }

        .ai-text {
            font-size: 1rem;
            line-height: 1.5;
            white-space: pre-wrap;
            word-wrap: break-word;
        }

        /* Action Buttons */
        .action-buttons {
            display: flex;
            gap: 0.5rem;
            align-items: center;
            margin-top: 0.5rem;
        }

        .action-btn {
            background: transparent;
            border: none;
            cursor: pointer;
            padding: 0.5rem;
            opacity: 0.6;
            transition: opacity 0.2s, transform 0.2s;
        }

        .action-btn:hover {
            opacity: 1;
            transform: scale(1.1);
        }

        .more-btn {
            margin-left: auto;
        }

        /* Disclaimer */
        .disclaimer {
            text-align: center;
            font-size: 0.75rem;
            color: rgba(255,255,255,0.5);
            margin-top: 1rem;
        }

        /* Input Area */
        .input-area {
            max-width:500px;
            margin: auto;
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: #131314;
            padding: 1rem;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            z-index: 50;
        }

        .input-area.chat-mode {
            background: #1e1f20;
            border-top-left-radius: 1.5rem;
            border-top-right-radius: 1.5rem;
        }

        .input-wrapper {
            background: #1e1f20;
            border-radius: 1.5rem;
            padding: 1rem 1.25rem;
            transition: all 0.3s ease;
        }

        .input-area.chat-mode .input-wrapper {
            background: transparent;
            padding: 0.5rem 0;
        }

        .input-field {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .input-field textarea {
            flex: 1;
            background: transparent;
            border: none;
            color: white;
            font-size: 1rem;
            outline: none;
            resize: none; 
            overflow: hidden;
            padding: 0; 
            margin-top: 4px;
            max-height: 100px;
            font-family: inherit;
        }

        .input-field textarea::placeholder {
            color: rgba(255,255,255,0.5);
        }

        .input-actions {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-top: 0.75rem;
            transition: all 0.3s ease;
        }

        .input-area.chat-mode .input-actions {
            margin-top: 0.5rem;
        }

        .left-actions {
            display: flex;
            gap: 0.5rem;
        }

        .action-icon {
            background: transparent;
            border: none;
            cursor: pointer;
            padding: 0.5rem;
            opacity: 0.7;
            transition: all 0.2s;
        }

        .action-icon:hover {
            opacity: 1;
        }

        .right-actions {
            width: auto;
            display: flex;
            gap: 0.5rem;
            align-items: center;
        }

        .model-btn {
            background: rgba(255,255,255,0.1);
            border: 1px solid rgba(255,255,255,0.2);
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 1.5rem;
            cursor: pointer;
            font-size: 0.85rem;
            transition: all 0.2s;
        }

        .model-btn:hover {
            background: rgba(255,255,255,0.15);
        }

        /* Tombol Wave & Send */
        .wave-btn, .verse-btn {
            background: rgba(255,255,255,0.1);
            border: none;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }

        .wave-btn.hidden {
            display: none;
        }

        .send-btn {
            background: #4285f4;
            border: none;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            cursor: pointer;
            display: none; 
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
            transform: scale(0);
        }

        .send-btn.visible {
            display: flex;
            animation: popIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards;
        }

        @keyframes popIn {
            from { transform: scale(0); }
            to { transform: scale(1); }
        }

        .send-btn:hover {
            background: #5a95f5;
        }

        .typing-indicator {
            display: flex;
            gap: 4px;
            padding: 1rem 0;
        }

        .typing-indicator span {
            width: 8px;
            height: 8px;
            background: #4285f4;
            border-radius: 50%;
            animation: bounce 1.4s infinite ease-in-out;
        }

        .typing-indicator span:nth-child(1) { animation-delay: 0s; }
        .typing-indicator span:nth-child(2) { animation-delay: 0.2s; }
        .typing-indicator span:nth-child(3) { animation-delay: 0.4s; }

        @keyframes bounce {
            0%, 80%, 100% { transform: translateY(0); }
            40% { transform: translateY(-8px); }
        }
        
        svg {
            fill: white;
        }
        
        .action-sheet-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 400;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease, visibility 0.3s ease;
        }
        
        .action-sheet-overlay.active {
            opacity: 1;
            visibility: visible;
        }
        
        .action-sheet {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            max-width: 500px;
            margin: 0 auto;
            background: #1e1f20;
            z-index: 500;
            transform: translateY(100%);
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            border-top-left-radius: 1.5rem;
            border-top-right-radius: 1.5rem;
            box-shadow: 0 -4px 20px rgba(0, 0, 0, 0.3);
        }
        
        .action-sheet.active {
            transform: translateY(0);
        }
        
        .action-sheet-header {
            padding: 1rem 1.25rem;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .action-sheet-title {
            font-size: 1.1rem;
            font-weight: 500;
            color: #4285f4;
        }

        .close-action-sheet {
            background: none;
            border: none;
            color: white;
            font-size: 1.5rem;
            cursor: pointer;
            opacity: 0.7;
            transition: opacity 0.2s;
            padding: 0.25rem;
        }

        .close-action-sheet:hover {
            opacity: 1;
        }

        .action-sheet-body {
            padding: 1.5rem 1.25rem 2rem;
        }

        .verse-selection-controls {
            display: flex;
            flex-direction: column;
            gap: 1rem;
            margin-bottom: 1.5rem;
        }

        .verse-selection-controls label {
            font-size: 0.9rem;
            color: rgba(255, 255, 255, 0.7);
            margin-bottom: -0.5rem;
        }

        .styled-select {
            width: 100%;
            padding: 0.75rem;
            background: #3c4043;
            border: 1px solid rgba(255, 255, 255, 0.1);
            color: white;
            border-radius: 0.75rem;
            font-size: 1rem;
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
            cursor: pointer;
            transition: border-color 0.2s;
        }

        .styled-select:focus {
            outline: none;
            border-color: #4285f4;
        }

        .select-verse-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            width: 100%;
            padding: 0.75rem 1rem;
            background: #4285f4;
            border: none;
            color: white;
            border-radius: 0.75rem;
            cursor: pointer;
            font-size: 1rem;
            transition: background 0.2s;
        }

        .select-verse-btn:hover {
            background: #5a95f5;
        }

        /* OFF CANVAS SIDEBAR */
        .offcanvas-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 200;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease, visibility 0.3s ease;
        }

        .offcanvas-overlay.active {
            opacity: 1;
            visibility: visible;
        }

        .offcanvas-sidebar {
            position: fixed;
            top: 0;
            left: 0;
            bottom: 0;
            width: 320px;
            background: #1e1f20;
            z-index: 300;
            transform: translateX(-100%);
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            display: flex;
            flex-direction: column;
            box-shadow: 2px 0 10px rgba(0, 0, 0, 0.3);
        }

        .offcanvas-sidebar.active {
            transform: translateX(0);
        }

        .offcanvas-header {
            padding: 1.5rem 1.25rem;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .offcanvas-title {
            font-size: 1.1rem;
            font-weight: 500;
        }

        .close-offcanvas {
            background: none;
            border: none;
            color: white;
            font-size: 1.5rem;
            cursor: pointer;
            opacity: 0.7;
            transition: opacity 0.2s;
            padding: 0.25rem;
        }

        .close-offcanvas:hover {
            opacity: 1;
        }

        .offcanvas-body {
            position: relative;
            flex: 1;
            padding: 1rem;
            overflow-y: auto;
        }

        .new-chat-btn {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            width: 100%;
            padding: 0.75rem 1rem;
            background: rgba(66, 133, 244, 0.1);
            border: 1px solid rgba(66, 133, 244, 0.3);
            color: white;
            border-radius: 0.75rem;
            cursor: pointer;
            font-size: 0.95rem;
            margin-bottom: 1.5rem;
            transition: all 0.2s;
        }

        .new-chat-btn:hover {
            background: rgba(66, 133, 244, 0.2);
        }

        .new-chat-btn svg {
            width: 20px;
            height: 20px;
            fill: #4285f4;
        }

        .chat-history-title {
            font-size: 0.9rem;
            color: rgba(255, 255, 255, 0.6);
            margin-bottom: 1rem;
            padding: 0 0.5rem;
        }

        .chat-history-list {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .chat-history-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.75rem 1rem;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 0.75rem;
            cursor: pointer;
            transition: all 0.2s;
        }

        .chat-history-item:hover {
            background: rgba(255, 255, 255, 0.08);
        }

        .chat-history-item.active {
            background: rgba(66, 133, 244, 0.15);
            border-left: 3px solid #4285f4;
        }

        .chat-preview {
            flex: 1;
            overflow: hidden;
        }

        .chat-preview-title {
            font-size: 0.9rem;
            margin-bottom: 0.25rem;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .chat-preview-date {
            font-size: 0.75rem;
            color: rgba(255, 255, 255, 0.5);
        }

        .delete-chat-btn {
            background: none;
            border: none;
            cursor: pointer;
            padding: 0.5rem;
            opacity: 0.5;
            transition: opacity 0.2s, transform 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .delete-chat-btn:hover {
            opacity: 1;
            transform: scale(1.1);
        }

        .delete-chat-btn svg {
            width: 18px;
            height: 18px;
        }

        .no-chats-message {
            text-align: center;
            padding: 2rem 1rem;
            color: rgba(255, 255, 255, 0.5);
            font-size: 0.9rem;
        }
        
        .quran-arabic {
            font-family: 'Amiri', 'Scheherazade New', 'Traditional Arabic', serif;
            font-size: 1.5rem;
            text-align: right;
            direction: rtl;
            line-height: 1.8;
            margin: 1rem 0;
            padding: 1rem;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 0.75rem;
            border-right: 3px solid #4285f4;
        }

        .quran-translation {
            font-size: 1rem;
            line-height: 1.6;
            margin: 0.5rem 0;
            padding: 0.75rem;
            background: rgba(255, 255, 255, 0.03);
            border-radius: 0.5rem;
            border-left: 2px solid #34a853;
        }
        
        .verse-header {
            font-size: 0.9rem;
            color: rgba(255, 255, 255, 0.7);
            margin-bottom: 0.5rem;
        }
        .surah-title {
            color: #4285f4;
            font-weight: 500;
        }
        .arabic-text {
            font-family: 'Amiri', 'Scheherazade New', 'Traditional Arabic', serif;
            font-size: 1.5rem;
            line-height: 1.8;
            padding: 1rem;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 0.75rem;
            border-right: 3px solid #4285f4;
            margin-bottom: 0.75rem;
        }
        .translation-text {
            font-size: 1rem;
            line-height: 1.6;
            padding: 0.75rem;
            background: rgba(255, 255, 255, 0.03);
            border-radius: 0.5rem;
            border-left: 2px solid #34a853;
        }

        .verse-container {
            margin: 1rem 0;
            padding: 1rem;
            background: rgba(255, 255, 255, 0.02);
            border-radius: 0.75rem;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .verse-reference {
            font-size: 0.85rem;
            color: #4285f4;
            margin-bottom: 0.5rem;
            font-weight: 500;
        }

        .copy-btn {
            background: rgba(66, 133, 244, 0.1);
            border: 1px solid rgba(66, 133, 244, 0.3);
            color: #4285f4;
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            cursor: pointer;
            font-size: 0.85rem;
            margin-top: 0.5rem;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
        }

        .copy-btn:hover {
            background: rgba(66, 133, 244, 0.2);
        }

        .copy-btn.copied {
            background: rgba(52, 168, 83, 0.2);
            border-color: rgba(52, 168, 83, 0.3);
            color: #34a853;
        }

        .source-badge {
            display: inline-block;
            background: rgba(255, 255, 255, 0.1);
            padding: 0.25rem 0.75rem;
            border-radius: 1rem;
            font-size: 0.75rem;
            margin-right: 0.5rem;
            margin-bottom: 0.5rem;
        }

        .language-selector {
            display: flex;
            gap: 0.5rem;
            margin: 1rem 0;
        }
        
        .language-toggle-wrapper {
            position: absolute;
            left: 0;
            bottom: 0;
            display: flex;
            align-items: center;
            gap: 10px;
            margin: 1.5rem;
        }
        
        .switch {
          position: relative;
          display: inline-block;
          width: 50px;
          height: 28px;
        }

        .switch input { 
          opacity: 0;
          width: 0;
          height: 0;
        }

        .slider {
          position: absolute;
          cursor: pointer;
          top: 0;
          left: 0;
          right: 0;
          bottom: 0;
          background-color: #ccc;
          transition: .4s;
          border-radius: 28px;
        }

        .slider:before {
          position: absolute;
          content: "";
          height: 20px;
          width: 20px;
          left: 4px;
          bottom: 4px;
          background-color: white;
          transition: .4s;
          border-radius: 50%;
        }

        input:checked + .slider {
          background-color: #4285f4;
        }

        input:focus + .slider {
          box-shadow: 0 0 1px #4285f4;
        }

        input:checked + .slider:before {
          transform: translateX(22px);
        }
        
        .lang-label {
            font-size: 0.9rem;
            font-weight: 500;
            color: rgba(255, 255, 255, 0.8);
        }

        .loading-spinner {
            width: 40px;
            height: 40px;
            border: 3px solid rgba(255, 255, 255, 0.1);
            border-top: 3px solid #4285f4;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .error-message {
            background: rgba(234, 67, 53, 0.1);
            border: 1px solid rgba(234, 67, 53, 0.3);
            color: #ea4335;
            padding: 1rem;
            border-radius: 0.75rem;
            margin: 1rem 0;
        }
        
        .usage-info {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 0.75rem;
            padding: 1rem;
            margin-top: 1rem;
            font-size: 0.85rem;
        }

        .usage-section {
            margin-bottom: 0.75rem;
        }

        .usage-title {
            color: #4285f4;
            font-weight: 500;
            margin-bottom: 0.5rem;
        }

        .usage-detail {
            display: flex;
            justify-content: space-between;
            margin-bottom: 0.25rem;
            color: rgba(255, 255, 255, 0.7);
        }

        .usage-label {
            font-weight: 500;
        }

        .usage-value {
            color: #34a853;
        }
        
.offcanvas-voice {
    position: fixed;
    bottom: 0;
    left: 0;
    right: 0;
    max-width: 500px;
    margin: 0 auto;
    background: #1e1f20;
    z-index: 300;
    transform: translateY(100%);
    transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    border-top-left-radius: 1.5rem;
    border-top-right-radius: 1.5rem;
    box-shadow: 0 -4px 20px rgba(0, 0, 0, 0.3);
    display: flex;
    flex-direction: column;
    height: 100%;
    max-height: 100vh;
}

.offcanvas-voice.active {
    transform: translateY(0);
}

.offcanvas-voice::before {
    content: '';
    position: absolute;
    top: 8px;
    left: 50%;
    transform: translateX(-50%);
    width: 40px;
    height: 4px;
    background: rgba(255, 255, 255, 0.2);
    border-radius: 2px;
}

.offcanvas-voice-header {
    padding: 1.5rem 1.25rem 1rem;
    border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    display: flex;
    justify-content: space-between;
    align-items: center;
    position: relative;
}

.offcanvas-voice-title {
    font-size: 1.1rem;
    font-weight: 500;
    color: #4285f4;
}

.offcanvas-voice-body {
    position: relative;
    flex: 1;
    padding: 1.5rem 1.25rem 2rem;
    overflow-y: auto;
}

/* Voice controls styling tetap sama */
.voice-controls {
    padding: 1.5rem;
    display: flex;
    flex-direction: column;
    gap: 1rem;
}

.voice-action-btn {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 0.75rem;
    width: 100%;
    padding: 1rem;
    background: #4285f4;
    border: none;
    color: white;
    border-radius: 0.75rem;
    cursor: pointer;
    font-size: 1rem;
    transition: all 0.2s;
}

.voice-action-btn:hover {
    background: #5a95f5;
}

.voice-action-btn svg {
    fill: white;
}

.recording-status {
    text-align: center;
    padding: 1rem;
    background: rgba(255, 255, 255, 0.05);
    border-radius: 0.75rem;
    font-size: 0.9rem;
    color: rgba(255, 255, 255, 0.8);
}

/* Wave Animation Styles */
.wave-animation {
    display: none; /* Awalnya hidden, akan di-show oleh JS */
    justify-content: center;
    align-items: center;
    height: 100px;
    gap: 8px;
    margin: 2rem 0;
}

.wave-bar {
    width: 6px;
    height: 40px;
    background: linear-gradient(135deg, #4285f4, #34a853);
    border-radius: 3px;
    animation: wave 1.2s infinite ease-in-out;
    transform-origin: bottom;
}

.wave-bar:nth-child(1) { animation-delay: -0.4s; }
.wave-bar:nth-child(2) { animation-delay: -0.3s; }
.wave-bar:nth-child(3) { animation-delay: -0.2s; }
.wave-bar:nth-child(4) { animation-delay: -0.1s; }
.wave-bar:nth-child(5) { animation-delay: 0s; }

@keyframes wave {
    0%, 60%, 100% { 
        transform: scaleY(0.3); 
        opacity: 0.5;
    }
    30% { 
        transform: scaleY(1); 
        opacity: 1;
    }
}

.recording-status {
    text-align: center;
    padding: 1rem;
    font-size: 1rem;
    color: #4285f4;
    font-weight: 500;
    transition: all 0.3s ease;
}

/* Responsive adjustments */
@media (max-width: 768px) {
    .offcanvas-voice {
        max-width: 100%;
        border-top-left-radius: 1.5rem;
        border-top-right-radius: 1.5rem;
    }
}

@media (max-width: 480px) {
    .offcanvas-voice {
        max-height: 85vh;
        border-top-left-radius: 1.25rem;
        border-top-right-radius: 1.25rem;
    }
    
    .offcanvas-voice-header {
        padding: 1.25rem 1rem 0.75rem;
    }
    
    .offcanvas-voice-body {
        padding: 1rem 1rem 1.5rem;
    }
}

#voiceOffcanvasOverlay {
    z-index: 250; /* Lebih rendah dari offcanvas-voice tapi lebih tinggi dari konten lain */
    background: rgba(0, 0, 0, 0.7); /* Lebih gelap */
}

@keyframes slideUpFade {
    from {
        opacity: 0;
        transform: translateY(20px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

.offcanvas-voice.active .voice-controls {
    animation: slideUpFade 0.3s ease 0.1s both;
}
        /* Responsif untuk mobile */
        @media (max-width: 768px) {
            .offcanvas-sidebar, .offcanvas-voice {
                width: 280px;
            }
            
            .quran-arabic {
                font-size: 1.3rem;
            }
        }

        @media (max-width: 480px) {
            .offcanvas-sidebar, .offcanvas-voice {
                width: 100%;
            }
            
            .quran-arabic {
                font-size: 1.2rem;
            }
            
            .input-area {
                padding: 0.75rem;
            }
        }

.elevenlabs-agent-widget {
    position: fixed !important;
    bottom: 100px !important;
    right: 20px !important;
    z-index: 1000 !important;
    border-radius: 20px !important;
    box-shadow: 0 10px 40px rgba(0, 0, 0, 0.5) !important;
}

.elevenlabs-agent-widget iframe {
    border-radius: 20px !important;
}

/* Hide default launcher since we use our own button */
.elevenlabs-agent-launcher {
    display: none !important;
}

/* Responsive */
@media (max-width: 768px) {
    .elevenlabs-agent-widget {
        bottom: 80px !important;
        right: 10px !important;
        width: calc(100vw - 20px) !important;
        max-width: 400px !important;
    }
}

.voice-header-main {
    display: flex;
    align-items: center;
    gap: 16px;
    flex: 1;
}

.voice-icon-wrapper {
    position: relative;
    width: 48px;
    height: 48px;
    display: flex;
    align-items: center;
    justify-content: center;
    background: linear-gradient(135deg, rgba(66, 133, 244, 0.1), rgba(52, 168, 83, 0.1));
    border-radius: 12px;
    padding: 10px;
}

.voice-main-icon {
    width: 24px;
    height: 24px;
    color: #4285f4;
    animation: gentle-bounce 2s ease-in-out infinite;
}

.voice-status-indicator {
    position: absolute;
    top: -4px;
    right: -4px;
    width: 16px;
    height: 16px;
}

.status-dot {
    width: 8px;
    height: 8px;
    color: #34a853;
    animation: pulse 2s infinite;
}

.voice-header-text {
    flex: 1;
}

.voice-title {
    display: flex;
    align-items: center;
    gap: 8px;
    font-size: 1.2rem;
    font-weight: 600;
    margin-bottom: 4px;
    color: white;
}

.title-icon {
    width: 20px;
    height: 20px;
    color: #4285f4;
}

.voice-subtitle {
    display: flex;
    align-items: center;
    gap: 6px;
    font-size: 0.85rem;
    color: rgba(255, 255, 255, 0.7);
}

.subtitle-icon {
    width: 14px;
    height: 14px;
    color: #fbbc04;
}

/* Status Display */
.voice-status-display {
    display: flex;
    align-items: center;
    gap: 16px;
    padding: 16px;
    background: rgba(255, 255, 255, 0.05);
    border-radius: 16px;
    margin: 24px 0;
    transition: all 0.3s ease;
}

.status-icon-wrapper {
    width: 48px;
    height: 48px;
    display: flex;
    align-items: center;
    justify-content: center;
    background: rgba(66, 133, 244, 0.1);
    border-radius: 50%;
}

.status-icon {
    width: 24px;
    height: 24px;
    color: #4285f4;
    transition: all 0.3s ease;
}

.status-text-wrapper {
    flex: 1;
    display: flex;
    flex-direction: column;
    gap: 4px;
}

.status-message {
    font-size: 1rem;
    font-weight: 500;
    color: white;
}

.status-details {
    display: flex;
    align-items: center;
    gap: 6px;
    font-size: 0.85rem;
    color: rgba(255, 255, 255, 0.6);
}

.info-icon {
    width: 14px;
    height: 14px;
    color: #fbbc04;
}

/* States */
.voice-status-display.listening {
    background: rgba(52, 168, 83, 0.1);
    border: 1px solid rgba(52, 168, 83, 0.2);
}

.voice-status-display.listening .status-icon {
    color: #34a853;
    animation: mic-pulse 1s infinite;
}

.voice-status-display.speaking {
    background: rgba(251, 188, 4, 0.1);
    border: 1px solid rgba(251, 188, 4, 0.2);
}

.voice-status-display.speaking .status-icon {
    color: #fbbc04;
    animation: speak-pulse 1s infinite;
}

.voice-status-display.error {
    background: rgba(234, 67, 53, 0.1);
    border: 1px solid rgba(234, 67, 53, 0.2);
}

.voice-status-display.error .status-icon {
    color: #ea4335;
}

/* Conversation Log */
.voice-conversation-log {
    max-height: 300px;
    overflow-y: auto;
    margin: 20px 0;
    padding: 16px;
    background: rgba(255, 255, 255, 0.03);
    border-radius: 16px;
    border: 1px solid rgba(255, 255, 255, 0.1);
}

.conversation-message {
    display: flex;
    gap: 12px;
    margin-bottom: 16px;
    padding: 12px;
    border-radius: 12px;
    animation: fadeIn 0.3s ease;
}

.message-user {
    background: rgba(66, 133, 244, 0.1);
    border-left: 3px solid #4285f4;
}

.message-ai {
    background: rgba(52, 168, 83, 0.1);
    border-left: 3px solid #34a853;
}

.message-icon {
    width: 20px;
    height: 20px;
    margin-top: 2px;
    flex-shrink: 0;
}

.message-user .message-icon {
    color: #4285f4;
}

.message-ai .message-icon {
    color: #34a853;
}

.message-content {
    flex: 1;
}

.message-text {
    font-size: 0.95rem;
    line-height: 1.5;
    color: white;
    word-wrap: break-word;
}

.message-time {
    font-size: 0.75rem;
    color: rgba(255, 255, 255, 0.5);
    margin-top: 4px;
    display: flex;
    align-items: center;
    gap: 4px;
}

.message-time i {
    width: 12px;
    height: 12px;
}

/* Tips Section */
.voice-tips {
    margin-top: 24px;
    padding: 16px;
    background: rgba(255, 255, 255, 0.05);
    border-radius: 16px;
    border: 1px solid rgba(255, 255, 255, 0.1);
}

.tip-item {
    display: flex;
    align-items: center;
    gap: 12px;
    margin-bottom: 12px;
    padding: 8px;
    border-radius: 8px;
    transition: background 0.2s;
}

.tip-item:hover {
    background: rgba(255, 255, 255, 0.08);
}

.tip-item:last-child {
    margin-bottom: 0;
}

.tip-item i {
    width: 18px;
    height: 18px;
    color: #fbbc04;
    flex-shrink: 0;
}

.tip-item span {
    font-size: 0.85rem;
    color: rgba(255, 255, 255, 0.8);
    line-height: 1.4;
}

/* Wave Animation */
.wave-animation-container {
    position: relative;
    padding: 24px;
    border-radius: 20px;
    background: linear-gradient(135deg, rgba(66, 133, 244, 0.05), rgba(52, 168, 83, 0.05));
    border: 1px solid rgba(255, 255, 255, 0.1);
    overflow: hidden;
}

.wave-bars {
    display: flex;
    justify-content: center;
    align-items: center;
    height: 80px;
    gap: 6px;
}

.wave-bar {
    width: 6px;
    height: 40px;
    background: linear-gradient(to top, #4285f4, #34a853);
    border-radius: 3px;
    opacity: 0.6;
}

.wave-bar:nth-child(1) { animation: wave 1.2s infinite ease-in-out -0.4s; }
.wave-bar:nth-child(2) { animation: wave 1.2s infinite ease-in-out -0.3s; }
.wave-bar:nth-child(3) { animation: wave 1.2s infinite ease-in-out -0.2s; }
.wave-bar:nth-child(4) { animation: wave 1.2s infinite ease-in-out -0.1s; }
.wave-bar:nth-child(5) { animation: wave 1.2s infinite ease-in-out 0s; }

/* Animations */
@keyframes gentle-bounce {
    0%, 100% { transform: translateY(0); }
    50% { transform: translateY(-4px); }
}

@keyframes pulse {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.5; }
}

@keyframes wave {
    0%, 60%, 100% { 
        transform: scaleY(0.3);
        opacity: 0.4;
    }
    30% { 
        transform: scaleY(1);
        opacity: 1;
    }
}

@keyframes mic-pulse {
    0%, 100% { 
        transform: scale(1);
        opacity: 1;
    }
    50% { 
        transform: scale(1.1);
        opacity: 0.8;
    }
}

@keyframes speak-pulse {
    0%, 100% { 
        transform: scale(1);
        color: #fbbc04;
    }
    50% { 
        transform: scale(1.15);
        color: #ffd633;
    }
}

@keyframes fadeIn {
    from { opacity: 0; transform: translateY(10px); }
    to { opacity: 1; transform: translateY(0); }
}

/* Responsive */
@media (max-width: 480px) {
    .voice-header-main {
        gap: 12px;
    }
    
    .voice-icon-wrapper {
        width: 40px;
        height: 40px;
    }
    
    .voice-main-icon {
        width: 20px;
        height: 20px;
    }
    
    .voice-status-display {
        flex-direction: column;
        text-align: center;
        gap: 12px;
    }
}
    </style>
    <link href="https://fonts.googleapis.com/css2?family=Amiri:wght@400;700&family=Scheherazade+New:wght@400;700&display=swap" rel="stylesheet">
    
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/lucide@latest/dist/umd/lucide.css">
    <script src="https://cdn.jsdelivr.net/npm/lucide@latest/dist/umd/lucide.min.js"></script>
</head>
<body>
    <header class="header">
        <div class="menu-icon" id="menuIcon">
            <span></span>
            <span></span>
            <span></span>
        </div>
        <div class="logo" id="chatTitle">
            <span class="logo-icon">stad</span>
             AI
        </div>
        <div class="avatar">AI</div>
    </header>

    <div class="offcanvas-overlay" id="offcanvasOverlay"></div>

    <div class="offcanvas-sidebar" id="offcanvasSidebar">
        <div class="offcanvas-header">
            <div class="offcanvas-title">Riwayat Percakapan</div>
            <button class="close-offcanvas" id="closeOffcanvas">&times;</button>
        </div>
        <div class="offcanvas-body">
            <button class="new-chat-btn" id="newChatBtn">
                <svg viewBox="0 0 24 24">
                    <path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z"/>
                </svg>
                <span>Obrolan Baru</span>
            </button>
            
            <div class="chat-history-title">Obrolan Terbaru</div>
            <div class="chat-history-list" id="chatHistoryList">
                <div class="no-chats-message">Belum ada riwayat percakapan</div>
            </div>
            
            <div class="language-toggle-wrapper">
                <label class="lang-label" id="langLabel">ID</label>
                <label class="switch">
                  <input type="checkbox" id="languageToggle">
                  <span class="slider"></span>
                </label>
            </div>
        </div>
    </div>
    
<div class="offcanvas-overlay" id="voiceOffcanvasOverlay"></div>

<div class="offcanvas-overlay" id="voiceOffcanvasOverlay"></div>
<div class="offcanvas-voice" id="offcanvasVoice">
  <div class="offcanvas-voice-header">
      <div class="voice-header-main">
          <div class="voice-icon-wrapper">
              <i data-lucide="mic" class="voice-main-icon"></i>
              <div class="voice-status-indicator">
                  <i data-lucide="circle" class="status-dot"></i>
              </div>
          </div>
          
          <div class="voice-header-text">
              <h3 class="voice-title">
                  <i data-lucide="messages-square" class="title-icon"></i>
                  Ustad Agent
              </h3>
              <p class="voice-subtitle" id="voiceSubtitle">
                  <i data-lucide="clock" class="subtitle-icon"></i>
              </p>
          </div>
      </div>
      
      <button class="close-offcanvas" id="closeOffcanvasVoice">
          <i data-lucide="x"></i>
      </button>
  </div>
<div class="offcanvas-voice-body">
    <div class="voice-controls">
        <!-- Wave Animation Container -->
        <div class="wave-animation-container">
            <div class="wave-bars">
                <div class="wave-bar"></div>
                <div class="wave-bar"></div>
                <div class="wave-bar"></div>
                <div class="wave-bar"></div>
                <div class="wave-bar"></div>
            </div>
            
            <!-- Status dengan Lucide Icons -->
            <div class="voice-status-display">
                <div class="status-icon-wrapper" id="statusIcon">
                    <i data-lucide="mic" class="status-icon"></i>
                </div>
                <div class="status-text-wrapper">
                    <span class="status-message" id="statusMessage">Tap to start conversation</span>
                    <span class="status-details" id="statusDetails">
                        <i data-lucide="info" class="info-icon"></i>
                        Real-time Quran Q&A
                    </span>
                </div>
            </div>
        </div>
        
        <!-- Conversation History (akan diisi secara dinamis) -->
        <div class="voice-conversation-log" id="voiceConversationLog">
            <!-- Messages akan muncul di sini -->
        </div>
        
        <!-- Tips Section -->
        <div class="voice-tips">
            <div class="tip-item">
                <i data-lucide="lightbulb"></i>
                <span>Ask about Quran verses, tafsir, or Islamic teachings</span>
            </div>
            <div class="tip-item">
                <i data-lucide="volume-2"></i>
                <span>AI will respond with voice and text simultaneously</span>
            </div>
            <div class="tip-item">
                <i data-lucide="clock"></i>
                <span>Close panel to save conversation to chat history</span>
            </div>
        </div>
    </div>
</div>
</div>

    <main class="main-content">
        <div class="welcome-state" id="welcomeState">
            <svg class="stad-sparkle" viewBox="0 0 24 24" width="60" height="60">
                <defs>
                    <linearGradient id="sparkleGradient" x1="0%" y1="0%" x2="100%" y2="100%">
                        <stop offset="0%" style="stop-color:#4285f4"/>
                        <stop offset="100%" style="stop-color:#34a853"/>
                    </linearGradient>
                </defs>
                <path fill="url(#sparkleGradient)" d="M12 0L13.5 8.5L22 10L13.5 11.5L12 20L10.5 11.5L2 10L10.5 8.5L12 0Z"/>
                <path fill="url(#sparkleGradient)" d="M19 3L19.5 5.5L22 6L19.5 6.5L19 9L18.5 6.5L16 6L18.5 5.5L19 3Z"/>
                <path fill="url(#sparkleGradient)" d="M5 15L5.5 17L7 17.5L5.5 18L5 20L4.5 18L3 17.5L4.5 17L5 15Z"/>
            </svg>
            <small>Assalamualaikum,</small>
            <p class="welcome-text">Ada yang bisa saya bantu tentang Al-Quran?</p>
            </div>

        <div class="chat-container" id="chatContainer"></div>
    </main>

    <div class="input-area" id="inputArea">
        <div class="input-wrapper">
            <div class="input-field">
                <textarea placeholder="Tanyakan tentang Al-Quran..." id="messageInput" rows="1"></textarea>
            </div>
            <div class="input-actions">
                <div class="left-actions">
    <button class="verse-btn" id="selectVerseBtn" title="Pilih Ayat">
        <svg width="20" height="20" viewBox="0 0 24 24">
            <path d="M19 2H6c-1.1 0-2 .9-2 2v16c0 1.1.9 2 2 2h13c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zM6 4h13v16H6V4zm2 10h9v2H8v-2zm0-3h9v2H8v-2zm0-3h9v2H8V8z"/>
        </svg>
    </button>
</div>

<div class="action-sheet-overlay" id="actionSheetOverlay"></div>
<div class="action-sheet" id="actionSheet">
    <div class="action-sheet-header">
        <div class="action-sheet-title">Pilih Ayat Al-Quran</div>
        <button class="close-action-sheet" id="closeActionSheet">&times;</button>
    </div>
    <div class="action-sheet-body">
        <div class="verse-selection-controls">
            <label for="surahSelect">Surah:</label>
            <select id="surahSelect" class="styled-select"></select>
            <label for="verseSelect">Ayat:</label>
            <select id="verseSelect" class="styled-select"></select>
        </div>
        <button class="select-verse-btn" id="goVerseBtn">
            <svg width="20" height="20" viewBox="0 0 24 24"><path d="M10 6L8.59 7.41 13.17 12l-4.58 4.59L10 18l6-6z"/></svg>
            Tampilkan Ayat
        </button>
    </div>
</div>

                <div class="right-actions">
                <button class="wave-btn" id="waveBtn" title="Voice Assistant">
                    <svg width="20" height="20" viewBox="0 0 24 24">
                        <path d="M7 18h2V6H7v12zm4 4h2V2h-2v20zm-8-8h2v-4H3v4zm12 4h2V6h-2v12zm4-8v4h2v-4h-2z"/>
                    </svg>
                </button>
                    
                    <button class="send-btn" id="sendBtn">
                        <svg width="20" height="20" viewBox="0 0 24 24">
                            <path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"/>
                        </svg>
                    </button>
                </div>
            </div>
        </div>
    </div>

<script>
  // Quran AI Chat Application
// ===============================================

// Constants
const Constants = {
    WORKER_URL: 'https://ai-quran-workers.harisudahmalam.workers.dev',
    SURAH_API_URL: 'https://api.alquran.cloud/v1/surah',
    TRANSLATION_LANG: 'id.indonesian',
    ARABIC_FONT: 'quran-uthmani',
    LOCAL_STORAGE_KEY: 'quranChatHistory',
    DEFAULT_LANGUAGE: 'id',
    SUPPORTED_LANGUAGES: {
        id: 'ID',
        en: 'EN'
    }
};

// State Management
class AppState {
    constructor() {
        this.currentChatId = null;
        this.chatHistory = [];
        this.isFirstMessage = true;
        this.currentLanguage = Constants.DEFAULT_LANGUAGE;
        this.surahData = [];
        this.surahMap = new Map();
        this.mediaRecorder = null;
        this.isRecording = false;
    }

    reset() {
        this.currentChatId = null;
        this.isFirstMessage = true;
        this.mediaRecorder = null;
        this.isRecording = false;
    }

    setLanguage(lang) {
        if (Object.keys(Constants.SUPPORTED_LANGUAGES).includes(lang)) {
            this.currentLanguage = lang;
            document.documentElement.lang = lang;
            return true;
        }
        return false;
    }
}

// DOM Elements Cache
class DomElements {
    constructor() {
        // Chat Elements
        this.chatContainer = document.getElementById('chatContainer');
        this.inputArea = document.getElementById('inputArea');
        this.messageInput = document.getElementById('messageInput');
        this.sendBtn = document.getElementById('sendBtn');
        this.waveBtn = document.getElementById('waveBtn');
        this.welcomeState = document.getElementById('welcomeState');
        
        // Offcanvas Elements
        this.menuIcon = document.getElementById('menuIcon');
        this.offcanvasOverlay = document.getElementById('offcanvasOverlay');
        this.offcanvasSidebar = document.getElementById('offcanvasSidebar');
        this.closeOffcanvas = document.getElementById('closeOffcanvas');
        
        // Voice Elements
        this.voiceOffcanvasOverlay = document.getElementById('voiceOffcanvasOverlay');
        this.offcanvasVoice = document.getElementById('offcanvasVoice');
        this.closeOffcanvasVoice = document.getElementById('closeOffcanvasVoice');
        this.startRecordingBtn = document.getElementById('startRecordingBtn');
        this.stopRecordingBtn = document.getElementById('stopRecordingBtn');
        this.recordingStatus = document.getElementById('recordingStatus');
        this.waveAnimation = document.getElementById('waveAnimation');
        
        // Chat History Elements
        this.chatHistoryList = document.getElementById('chatHistoryList');
        this.newChatBtn = document.getElementById('newChatBtn');
        
        // Language Elements
        this.languageToggle = document.getElementById('languageToggle');
        this.langLabel = document.getElementById('langLabel');
        this.chatTitle = document.getElementById('chatTitle');
        
        // Verse Selection Elements
        this.selectVerseBtn = document.getElementById('selectVerseBtn');
        this.actionSheetOverlay = document.getElementById('actionSheetOverlay');
        this.actionSheet = document.getElementById('actionSheet');
        this.closeActionSheet = document.getElementById('closeActionSheet');
        this.surahSelect = document.getElementById('surahSelect');
        this.verseSelect = document.getElementById('verseSelect');
        this.goVerseBtn = document.getElementById('goVerseBtn');
    }

    validate() {
        const requiredElements = [
            'chatContainer', 'messageInput', 'sendBtn', 'welcomeState',
            'menuIcon', 'waveBtn', 'languageToggle', 'langLabel'
        ];
        
        return requiredElements.every(element => this[element] !== null);
    }
}

// API Service
class ApiService {
    static async fetchSurahList() {
        try {
            const response = await fetch(`${Constants.WORKER_URL}/api/surah`);
            if (!response.ok) throw new Error('Failed to load surah list');
            return await response.json();
        } catch (error) {
            console.error('Primary surah API failed, trying fallback:', error);
            return await ApiService.fetchSurahListFallback();
        }
    }

    static async fetchSurahListFallback() {
        try {
            const response = await fetch(Constants.SURAH_API_URL);
            const data = await response.json();
            return data.data;
        } catch (error) {
            console.error('Fallback surah API failed:', error);
            return [];
        }
    }

    static async fetchSurahVerse(surahNumber, ayahNumber) {
        try {
            const [arabicResponse, translationResponse] = await Promise.all([
                fetch(`https://api.alquran.cloud/v1/surah/${surahNumber}/${Constants.ARABIC_FONT}`),
                fetch(`https://api.alquran.cloud/v1/surah/${surahNumber}/${Constants.TRANSLATION_LANG}`)
            ]);

            if (!arabicResponse.ok || !translationResponse.ok) {
                throw new Error('API request failed');
            }

            const [arabicData, translationData] = await Promise.all([
                arabicResponse.json(),
                translationResponse.json()
            ]);

            return {
                arabicData,
                translationData,
                success: true
            };
        } catch (error) {
            console.error('Surah verse API failed:', error);
            return { success: false, error };
        }
    }

    static async fetchSingleVerse(surahNumber, ayahNumber) {
        try {
            const response = await fetch(`https://api.alquran.cloud/v1/ayah/${surahNumber}:${ayahNumber}`);
            if (!response.ok) throw new Error('Single verse API failed');
            return await response.json();
        } catch (error) {
            console.error('Single verse API failed:', error);
            return null;
        }
    }

    static async sendQuestion(question, language) {
        try {
            const response = await fetch(`${Constants.WORKER_URL}/api/ask`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ question, language })
            });

            if (!response.ok) {
                const errorText = await response.text();
                throw new Error(`HTTP ${response.status}: ${errorText}`);
            }

            return await response.json();
        } catch (error) {
            console.error('Question API failed:', error);
            throw error;
        }
    }

    static async sendAudio(audioBlob, language) {
        const formData = new FormData();
        formData.append('audio', audioBlob, 'recording.webm');
        formData.append('language', language);

        try {
            const response = await fetch('/api/voice-ask', {
                method: 'POST',
                body: formData
            });

            return await response.json();
        } catch (error) {
            console.error('Audio API failed:', error);
            throw error;
        }
    }
}

// Chat Manager
class ChatManager {
    constructor(state, dom, aiHandler) {
        this.state = state;
        this.dom = dom;
        this.aiHandler = aiHandler;
        this.verseManager = null;
    }
    setVerseManager(verseManager) {
        this.verseManager = verseManager;
    }

    createNewChat(shouldLoad = true) {
        const newChat = {
            id: Date.now(),
            title: this.getLocalizedText('New Chat', 'Obrolan Baru'),
            messages: [],
            createdAt: new Date().toISOString()
        };

        this.state.chatHistory.unshift(newChat);
        this.saveToLocalStorage();

        if (shouldLoad) {
            this.loadChat(newChat.id);
        }

        this.renderChatHistory();
        return newChat;
    }

    loadChat(chatId) {
        const chat = this.state.chatHistory.find(c => c.id === chatId);
        if (!chat) return;

        this.state.currentChatId = chatId;
        this.state.isFirstMessage = chat.messages.length === 0;

        this.clearChatContainer();

        if (this.state.isFirstMessage) {
            this.showWelcomeState();
        } else {
            this.hideWelcomeState();
            this.renderChatMessages(chat.messages);
        }

        this.renderChatHistory();
        this.updateChatTitle(chat.title);
        this.scrollToBottom();
    }

    renderChatMessages(messages) {
    messages.forEach(message => {

        this.appendUserMessage(message.user);

        if (message.type === 'verse') {
            this.displayVerseResponse(message.ai, false);
        } else if (message.type === 'error') {
            this.showError(message.ai);
        } else if (message.type === 'quran_ai') {

            if (this.aiHandler) {
                this.aiHandler.displayBackendAIResponse(message.user, message.ai, false);
            } else {

                this.appendAIResponse(typeof message.ai === 'string' 
                    ? message.ai 
                    : (message.ai.answer || JSON.stringify(message.ai)));
            }
        } else {

            this.appendAIResponse(message.ai);
        }
    });

    this.scrollToBottom();
}

    appendUserMessage(text) {
        const messageEl = this.createMessageElement('user-message', text);
        this.dom.chatContainer.appendChild(messageEl);
    }

    appendAIResponse(text, options = {}) {
        const responseEl = this.createMessageElement('ai-response', text);
        if (options.isError) {
            responseEl.classList.add('error-message');
        }
        this.dom.chatContainer.appendChild(responseEl);
    }

    createMessageElement(className, text) {
        const element = document.createElement('div');
        element.className = className;
        element.textContent = text;
        return element;
    }

    showTypingIndicator() {
        const typingEl = document.createElement('div');
        typingEl.className = 'ai-response typing-indicator';
        typingEl.innerHTML = `
            <div class="typing-indicator">
                <span class="dot"></span>
                <span class="dot"></span>
                <span class="dot"></span>
            </div>
        `;
        this.dom.chatContainer.appendChild(typingEl);
        this.scrollToBottom();
        return typingEl;
    }

    removeTypingIndicator() {
        const typingEl = this.dom.chatContainer.querySelector('.typing-indicator');
        if (typingEl) {
            typingEl.remove();
        }
    }

    showWelcomeState() {
        this.dom.welcomeState.classList.remove('hidden');
        this.dom.chatContainer.classList.remove('active');
        this.dom.inputArea.classList.remove('chat-mode');
    }

    hideWelcomeState() {
        this.dom.welcomeState.classList.add('hidden');
        this.dom.chatContainer.classList.add('active');
        this.dom.inputArea.classList.add('chat-mode');
    }

    clearChatContainer() {
        this.dom.chatContainer.innerHTML = '';
    }

    updateChatTitle(title) {
        this.dom.chatTitle.textContent = title || this.getLocalizedText('New Chat', 'Obrolan Baru');
    }
    
    scrollToBottom() {
        if (!this.dom.chatContainer) return;
        
        setTimeout(() => {
            const container = this.dom.chatContainer;
            container.scrollTop = container.scrollHeight;
            requestAnimationFrame(() => {
                container.scrollTop = container.scrollHeight;
            });
        }, 10);
    }

    saveToLocalStorage() {
        try {
            localStorage.setItem(
                Constants.LOCAL_STORAGE_KEY, 
                JSON.stringify(this.state.chatHistory)
            );
        } catch (error) {
            console.error('Failed to save to localStorage:', error);
        }
    }

    loadFromLocalStorage() {
        try {
            const history = localStorage.getItem(Constants.LOCAL_STORAGE_KEY);
            if (history) {
                this.state.chatHistory = JSON.parse(history);
            }
        } catch (error) {
            console.error('Failed to load from localStorage:', error);
            this.state.chatHistory = [];
            localStorage.removeItem(Constants.LOCAL_STORAGE_KEY);
        }
    }

    renderChatHistory() {
        if (!this.dom.chatHistoryList) return;

        this.dom.chatHistoryList.innerHTML = '';

        if (this.state.chatHistory.length === 0) {
            this.dom.chatHistoryList.innerHTML = `
                <div class="no-chats-message">
                    ${this.getLocalizedText('No chat history yet.', 'Belum ada riwayat percakapan')}
                </div>
            `;
            return;
        }

        this.state.chatHistory.forEach(chat => {
            const item = document.createElement('div');
            item.className = `chat-history-item ${chat.id === this.state.currentChatId ? 'active' : ''}`;
            item.dataset.chatId = chat.id;

            item.innerHTML = `
                <div class="chat-preview">
                    <div class="chat-preview-title">${chat.title}</div>
                    <div class="chat-preview-date">${this.formatDate(chat.createdAt)}</div>
                </div>
                <button class="delete-chat-btn" data-chat-id="${chat.id}">
                    <svg width="18" height="18" viewBox="0 0 24 24">
                        <path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zm2.46-7.12l1.41-1.41L12 12.59l2.12-2.12 1.41 1.41L13.41 14l2.12 2.12-1.41 1.41L12 15.41l-2.12 2.12-1.41-1.41L10.59 14l-2.12-2.12zM15.5 4l-1-1h-5l-1 1H5v2h14V4z"/>
                    </svg>
                </button>
            `;

            item.addEventListener('click', () => this.loadChat(chat.id));
            
            const deleteBtn = item.querySelector('.delete-chat-btn');
            deleteBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                this.deleteChat(chat.id);
            });

            this.dom.chatHistoryList.appendChild(item);
        });
    }

    deleteChat(chatId) {
        const message = this.getLocalizedText(
            'Are you sure you want to delete this conversation?',
            'Apakah Anda yakin ingin menghapus percakapan ini?'
        );

        if (!confirm(message)) return;

        const wasActiveChat = this.state.currentChatId === chatId;
        this.state.chatHistory = this.state.chatHistory.filter(chat => chat.id !== chatId);
        this.saveToLocalStorage();

        if (wasActiveChat) {
            if (this.state.chatHistory.length > 0) {
                this.loadChat(this.state.chatHistory[0].id);
            } else {
                this.state.reset();
                this.showWelcomeState();
                this.renderChatHistory();
            }
        } else {
            this.renderChatHistory();
        }
    }

    saveMessageToHistory(userMessage, aiResponse, type = 'text') {
        let currentChat = this.state.chatHistory.find(c => c.id === this.state.currentChatId);

        if (!currentChat) {
            currentChat = this.createNewChat(false);
            this.state.currentChatId = currentChat.id;
        }

        if (currentChat.messages.length === 0) {
            const title = type === 'verse' 
                ? userMessage 
                : userMessage.split(/\s+/).slice(0, 5).join(' ') + (userMessage.split(/\s+/).length > 5 ? '...' : '');
            currentChat.title = title;
            this.updateChatTitle(title);
        }

        currentChat.messages.push({
            user: userMessage,
            ai: aiResponse,
            type: type,
            timestamp: new Date().toISOString()
        });

        // Move to top of history
        this.state.chatHistory = this.state.chatHistory.filter(c => c.id !== currentChat.id);
        this.state.chatHistory.unshift(currentChat);

        this.saveToLocalStorage();
        this.renderChatHistory();
    }

    formatDate(dateString) {
        const date = new Date(dateString);
        const now = new Date();
        const diffTime = Math.abs(now - date);
        const diffDays = Math.floor(diffTime / (1000 * 60 * 60 * 24));

        if (diffDays === 0) {
            return this.getLocalizedText('Today', 'Hari ini');
        } else if (diffDays === 1) {
            return this.getLocalizedText('Yesterday', 'Kemarin');
        } else if (diffDays < 7) {
            return this.getLocalizedText(`${diffDays} days ago`, `${diffDays} hari lalu`);
        } else {
            return date.toLocaleDateString(this.state.currentLanguage === 'id' ? 'id-ID' : 'en-US', {
                day: 'numeric',
                month: 'short'
            });
        }
    }

    getLocalizedText(english, indonesian) {
        return this.state.currentLanguage === 'id' ? indonesian : english;
    }
}

// Verse Manager
class VerseManager {
    constructor(state, dom, chatManager) {
        this.state = state;
        this.dom = dom;
        this.chatManager = chatManager;
    }

    async loadSurahData() {
        try {
            this.state.surahData = await ApiService.fetchSurahList();
            this.buildSurahMap();
            return true;
        } catch (error) {
            console.error('Failed to load surah data:', error);
            return false;
        }
    }

    buildSurahMap() {
        this.state.surahMap.clear();
        this.state.surahData.forEach(surah => {
            const key = surah.id || surah.number;
            this.state.surahMap.set(parseInt(key), {
                id: key,
                name: surah.transliteration || surah.englishName || surah.name,
                nameArabic: surah.name,
                nameTranslation: surah.translation || surah.englishNameTranslation,
                ayahs: surah.total_verses || surah.numberOfAyahs
            });
        });
    }

    populateSurahSelect() {
        if (!this.dom.surahSelect || this.state.surahData.length === 0) return;

        this.dom.surahSelect.innerHTML = '';
        this.state.surahData.forEach(surah => {
            const option = document.createElement('option');
            option.value = surah.id || surah.number;
            
            const displayName = this.state.currentLanguage === 'id'
                ? (surah.translation || surah.englishNameTranslation || surah.name)
                : (surah.transliteration || surah.englishName || surah.name);
            
            option.textContent = `${surah.id || surah.number}. ${displayName} (${surah.name})`;
            this.dom.surahSelect.appendChild(option);
        });

        this.populateVerseSelect();
    }

    populateVerseSelect() {
        if (!this.dom.verseSelect) return;

        const selectedSurahId = parseInt(this.dom.surahSelect.value);
        const selectedSurah = this.state.surahMap.get(selectedSurahId);

        this.dom.verseSelect.innerHTML = '';

        if (selectedSurah) {
            for (let i = 1; i <= selectedSurah.ayahs; i++) {
                const option = document.createElement('option');
                option.value = i;
                option.textContent = this.chatManager.getLocalizedText(`Verse ${i}`, `Ayat ${i}`);
                this.dom.verseSelect.appendChild(option);
            }
        }
    }

    async getSpecificVerse() {
        const surahNumber = this.dom.surahSelect.value;
        const ayahNumber = parseInt(this.dom.verseSelect.value);

        if (!surahNumber || !ayahNumber) return;

        this.closeActionSheet();

        const surahInfo = this.state.surahMap.get(parseInt(surahNumber));
        if (!surahInfo) {
            this.chatManager.showError(
                this.chatManager.getLocalizedText('Surah data not found.', 'Data surah tidak ditemukan.')
            );
            return;
        }

        const userMessage = this.chatManager.getLocalizedText(
            `Show ${surahInfo.name} verse ${ayahNumber}`,
            `${surahInfo.name} ayat ${ayahNumber}`
        );

        this.chatManager.appendUserMessage(userMessage);

        if (this.state.isFirstMessage) {
            this.chatManager.hideWelcomeState();
            this.state.isFirstMessage = false;
            if (this.state.currentChatId === null) {
                this.chatManager.createNewChat(false);
            }
        }

        const typingEl = this.chatManager.showTypingIndicator();

        try {
            // Try primary API
            const result = await ApiService.fetchSurahVerse(surahNumber, ayahNumber);
            
            if (result.success) {
                typingEl.remove();
                this.displayVerse(surahNumber, ayahNumber, result.arabicData, result.translationData, surahInfo);
            } else {
                // Try fallback
                const fallbackResult = await ApiService.fetchSingleVerse(surahNumber, ayahNumber);
                typingEl.remove();
                
                if (fallbackResult) {
                    this.displayVerseFromSingleAPI(surahNumber, ayahNumber, fallbackResult, surahInfo);
                } else {
                    throw new Error('All API attempts failed');
                }
            }
        } catch (error) {
            typingEl.remove();
            this.chatManager.showError(
                this.chatManager.getLocalizedText(
                    `Failed to get verse ${surahNumber}:${ayahNumber}. Error: ${error.message}`,
                    `Gagal mendapatkan ayat ${surahNumber}:${ayahNumber}. Error: ${error.message}`
                )
            );
        }
    }

    displayVerse(surahNumber, ayahNumber, arabicData, translationData, surahInfo) {
        const arabicSurah = arabicData.data;
        const translationSurah = translationData.data;

        const arabicAyah = arabicSurah.ayahs.find(ayah => ayah.numberInSurah === ayahNumber);
        const translationAyah = translationSurah.ayahs.find(ayah => ayah.numberInSurah === ayahNumber);

        if (!arabicAyah) {
            throw new Error('Verse not found in Arabic text');
        }

        const aiResponse = {
            surahNumber,
            surahName: surahInfo.name,
            surahNameArabic: surahInfo.nameArabic,
            ayahNumber,
            arabicText: arabicAyah.text,
            translationText: translationAyah ? translationAyah.text : 
                this.chatManager.getLocalizedText('Translation not available', 'Terjemahan tidak tersedia')
        };

        this.displayVerseResponse(aiResponse, true);
    }

    displayVerseFromSingleAPI(surahNumber, ayahNumber, apiResult, surahInfo) {
        const aiResponse = {
            surahNumber,
            surahName: surahInfo.name,
            ayahNumber,
            arabicText: apiResult.data.text || 'Teks tidak tersedia',
            translationText: apiResult.data.translation || 
                this.chatManager.getLocalizedText('Translation not available', 'Terjemahan tidak tersedia')
        };

        this.displayVerseResponse(aiResponse, true);
    }

    displayVerseResponse(aiResponse, saveToHistory = true) {
    if (this.verseManager) {
        this.verseManager.displayVerseResponse(aiResponse, saveToHistory);
    } else {
        // Fallback jika verseManager belum tersedia
        const responseEl = document.createElement('div');
        responseEl.className = 'ai-response';
        
        const html = `
            <div class="verse-header">
                <span class="surah-title">${aiResponse.surahNameArabic || aiResponse.surahName} (${aiResponse.surahNumber}:${aiResponse.ayahNumber})</span>
            </div>
            <div class="arabic-text" dir="rtl">
                ${aiResponse.arabicText}
            </div>
            <div class="translation-text">
                ${this.getLocalizedText('Translation:', 'Terjemahan:')} ${aiResponse.translationText}
            </div>
        `;
        
        responseEl.innerHTML = html;
        this.dom.chatContainer.appendChild(responseEl);
        
        if (saveToHistory) {
            this.saveMessageToHistory(
                this.getLocalizedText(
                    `Verse ${aiResponse.surahNumber}:${aiResponse.ayahNumber}`,
                    `Ayat ${aiResponse.surahNumber}:${aiResponse.ayahNumber}`
                ),
                aiResponse,
                'verse'
            );
        }
        
        this.scrollToBottom();
    }
}

    openActionSheet() {
        this.dom.actionSheetOverlay.classList.add('active');
        this.dom.actionSheet.classList.add('active');
        document.body.style.overflow = 'hidden';

        if (this.state.surahData.length > 0) {
            this.populateSurahSelect();
            this.populateVerseSelect();
        } else {
            this.dom.surahSelect.innerHTML = `<option>${this.chatManager.getLocalizedText('Loading Surahs...', 'Memuat Surah...')}</option>`;
            this.dom.verseSelect.innerHTML = `<option>-</option>`;
            this.loadSurahData();
        }
    }

    closeActionSheet() {
        this.dom.actionSheetOverlay.classList.remove('active');
        this.dom.actionSheet.classList.remove('active');
        document.body.style.overflow = '';
    }
}

// Voice Manager
class VoiceManager {
    constructor(state, dom, chatManager) {
        this.state = state;
        this.dom = dom;
        this.chatManager = chatManager;
        this.elevenLabsAgent = null;
        this.isConversationActive = false;
        this.conversationHistory = [];
    }

    async openVoicePanel() {
        console.log('Opening voice panel...');

        this.dom.voiceOffcanvasOverlay.classList.add('active');
        this.dom.offcanvasVoice.classList.add('active');
        document.body.style.overflow = 'hidden';

        this.showWaveAnimation(true);
        this.updateStatus('Menyiapkan voice assistant...');

        setTimeout(() => this.startElevenLabsConversation(), 300);
    }

    async startElevenLabsConversation() {
        try {

            if (!window.ElevenLabs) {
                await this.loadElevenLabsSDK();
            }

            const agentOptions = {
                agentId: "agent_1801kbypkmmqefn8z5zvzk508b70",
                voice: {
                    voiceId: "21m00Tcm4TlvDq8ikWAM",
                    modelId: "eleven_multilingual_v2",
                    settings: {
                        stability: 0.5,
                        similarity_boost: 0.8
                    }
                },
                ui: {
                    showLauncher: false, 

                    showCloseButton: false
                },
                tools: {
                    webhooks: [{
                        name: "quran-ai-webhook",
                        description: "AI assistant khusus Al-Quran",
                        api_schema: {
                            url: "https://ai-quran-workers.harisudahmalam.workers.dev/api/elevenhook",
                            method: "POST"
                        }
                    }]
                },

                autoStart: true,
                initialMessage: "Assalamualaikum, saya Ustad AI. Ada yang bisa saya bantu tentang Al-Quran?",
                language: this.state.currentLanguage === 'id' ? 'id' : 'en'
            };

            this.elevenLabsAgent = new window.ElevenLabs.Agent(agentOptions);

  this.setupAgentEvents();

            setTimeout(() => {
                if (this.elevenLabsAgent) {
                    this.elevenLabsAgent.start();
                    this.isConversationActive = true;
                    this.updateStatus(' Ready - Speak now...');
                }
            }, 500);

        } catch (error) {
            console.error('Failed to start ElevenLabs:', error);
            this.updateStatus(' Error: ' + error.message);
            this.showWaveAnimation(false);
        }
    }

    setupAgentEvents() {
        if (!this.elevenLabsAgent) return;

        this.elevenLabsAgent.on('listening', () => {
            console.log('ElevenLabs: Listening...');
            this.showWaveAnimation(true);
            this.updateStatus(' Listening... (speak now)');
        });

        this.elevenLabsAgent.on('speaking', (data) => {
            console.log('ElevenLabs: Speaking...', data);
            this.showWaveAnimation(true);
            this.updateStatus(' AI is speaking...');

            if (data?.text) {
                this.addToConversation('ai', data.text);
            }
        });

        this.elevenLabsAgent.on('idle', () => {
            console.log('ElevenLabs: Idle');
            this.showWaveAnimation(false);
            this.updateStatus(' Ready for next question');
        });

        this.elevenLabsAgent.on('userSpeech', (text) => {
            console.log('User said:', text);
            this.addToConversation('user', text);
        });

        this.elevenLabsAgent.on('error', (error) => {
            console.error('ElevenLabs Agent error:', error);
            this.updateStatus(' Error: ' + error.message);
            this.showWaveAnimation(false);
        });
    }

    addToConversation(speaker, text) {
        const conversationEl = document.getElementById('voiceConversation');
        if (!conversationEl) return;

        const messageDiv = document.createElement('div');
        messageDiv.className = `voice-message ${speaker}`;
        messageDiv.style.cssText = `
            margin: 8px 0;
            padding: 10px 15px;
            border-radius: 15px;
            max-width: 80%;
            word-wrap: break-word;
            font-size: 0.9rem;
            ${speaker === 'user' 
                ? 'background: #4285f4; color: white; margin-left: auto;' 
                : 'background: rgba(255,255,255,0.1);'}
        `;

        messageDiv.textContent = `${speaker === 'user' ? ' You' : ' AI'}: ${text}`;
        conversationEl.appendChild(messageDiv);

        conversationEl.scrollTop = conversationEl.scrollHeight;

        this.conversationHistory.push({
            speaker,
            text,
            timestamp: new Date().toISOString()
        });
    }

    async loadElevenLabsSDK() {
        return new Promise((resolve, reject) => {
            if (window.ElevenLabs) {
                resolve();
                return;
            }

            const script = document.createElement('script');
            script.src = 'https://elevenlabs.io/agent-widget/index.js';
            script.defer = true;
            script.onload = () => {
                console.log('ElevenLabs SDK loaded');
                resolve();
            };
            script.onerror = reject;
            document.head.appendChild(script);
        });
    }

    closeVoicePanel() {

        if (this.elevenLabsAgent && this.isConversationActive) {
            this.elevenLabsAgent.stop();
            this.isConversationActive = false;
        }

        this.dom.voiceOffcanvasOverlay.classList.remove('active');
        this.dom.offcanvasVoice.classList.remove('active');
        document.body.style.overflow = '';
        this.showWaveAnimation(false);
        this.updateStatus('Starting voice assistant...');

        const conversationEl = document.getElementById('voiceConversation');
        if (conversationEl) conversationEl.innerHTML = '';

        if (this.conversationHistory.length > 0) {
            this.saveConversationToChat();
        }

        this.conversationHistory = [];
    }

    saveConversationToChat() {

        const userMessages = this.conversationHistory
            .filter(msg => msg.speaker === 'user')
            .map(msg => msg.text)
            .join('\n');

        const aiMessages = this.conversationHistory
            .filter(msg => msg.speaker === 'ai')
            .map(msg => msg.text)
            .join('\n');

        if (userMessages && aiMessages && this.chatManager) {

            this.chatManager.saveMessageToHistory(
                `[Voice Conversation] ${userMessages.substring(0, 50)}...`,
                ` Voice Assistant Conversation:\n\n${aiMessages}`,
                'quran_ai'
            );
        }
    }

    showWaveAnimation(show) {
        if (this.dom.waveAnimation) {
            this.dom.waveAnimation.style.display = show ? 'flex' : 'none';
        }
    }

    updateStatus(text) {
        if (this.dom.recordingStatus) {
            this.dom.recordingStatus.textContent = text;
        }
    }
}

// AI Response Handler
class AIResponseHandler {
    constructor(state, dom, chatManager) {
        this.state = state;
        this.dom = dom;
        this.chatManager = chatManager;
    }
    
    setChatManager(chatManager) {
        this.chatManager = chatManager;
    }

    displayBackendAIResponse(userMessage, backendResponse, saveToHistory = true) {
        // Pastikan kita memiliki DOM element
        if (!this.dom.chatContainer) {
            console.error('Chat container not found');
            return;
        }
        
        const responseEl = document.createElement('div');
        responseEl.className = 'ai-response';

        let html = '';

        if (backendResponse.success) {
            html += `<div class="ai-text">${backendResponse.answer}</div>`;

            if (backendResponse.verses_data && backendResponse.verses_data.length > 0) {
                html += `<div class="verses-section" style="margin-top: 1rem;">`;
                backendResponse.verses_data.forEach(verse => {
                    html += `
                        <div class="verse-container">
                            <div class="verse-reference">${verse.reference}</div>
                            <div class="arabic-text" dir="rtl">${verse.verse_arabic}</div>
                            <div class="translation-text">${verse.verse_translation}</div>
                        </div>
                    `;
                });
                html += `</div>`;
            }

            if (backendResponse.disclaimer) {
                html += `<div class="disclaimer">${backendResponse.disclaimer}</div>`;
            }

            if (backendResponse.usage) {
                const usage = backendResponse.usage;
                html += this.renderUsageInfo(usage);
            }

        } else {
            html += `<div class="error-message">${backendResponse.error || 'Terjadi kesalahan'}</div>`;

            if (backendResponse.verses_data && backendResponse.verses_data.length > 0) {
                html += `<div class="ai-text">${backendResponse.answer || ''}</div>`;
                html += `<div class="verses-section" style="margin-top: 1rem;">`;
                backendResponse.verses_data.forEach(verse => {
                    html += `
                        <div class="verse-container">
                            <div class="verse-reference">${verse.reference}</div>
                            <div class="arabic-text" dir="rtl">${verse.verse_arabic}</div>
                            <div class="translation-text">${verse.verse_translation}</div>
                        </div>
                    `;
                });
                html += `</div>`;
            }

            if (backendResponse.limit_info) {
                html += this.renderLimitInfo(backendResponse.limit_info);
            }
        }

        responseEl.innerHTML = html;
        this.dom.chatContainer.appendChild(responseEl);

        if (saveToHistory && this.chatManager) {
            this.chatManager.saveMessageToHistory(userMessage, backendResponse, 'quran_ai');
        }

        if (this.chatManager) {
            this.chatManager.scrollToBottom();
        }
    }


    renderUsageInfo(usage) {
        return `
            <div class="usage-info">
                <div class="usage-section">
                    <div class="usage-title">${this.chatManager.getLocalizedText('Token Usage', 'Penggunaan Token')}</div>
                    <div class="usage-detail">
                        <span class="usage-label">${this.chatManager.getLocalizedText('Input', 'Input')}</span>
                        <span class="usage-value">${usage.tokens.input}</span>
                    </div>
                    <div class="usage-detail">
                        <span class="usage-label">${this.chatManager.getLocalizedText('Output', 'Output')}</span>
                        <span class="usage-value">${usage.tokens.output}</span>
                    </div>
                    <div class="usage-detail">
                        <span class="usage-label">${this.chatManager.getLocalizedText('Total', 'Total')}</span>
                        <span class="usage-value">${usage.tokens.total}</span>
                    </div>
                </div>

                <div class="usage-section">
                    <div class="usage-title">${this.chatManager.getLocalizedText('Neuron Usage', 'Penggunaan Neuron')}</div>
                    <div class="usage-detail">
                        <span class="usage-label">${this.chatManager.getLocalizedText('Consumed', 'Digunakan')}</span>
                        <span class="usage-value">${usage.neurons.formatted} neurons</span>
                    </div>
                </div>
            </div>
        `;
    }

    renderLimitInfo(limitInfo) {
        return `
            <div class="usage-info">
                <div class="usage-section">
                    <div class="usage-title">${this.chatManager.getLocalizedText('Daily Limit', 'Batas Harian')}</div>
                    <div class="usage-detail">
                        <span class="usage-label">${this.chatManager.getLocalizedText('Consumed', 'Digunakan')}</span>
                        <span class="usage-value">${this.formatNeuronsDisplay(limitInfo.consumed)}</span>
                    </div>
                    <div class="usage-detail">
                        <span class="usage-label">${this.chatManager.getLocalizedText('Remaining', 'Tersisa')}</span>
                        <span class="usage-value">${this.formatNeuronsDisplay(limitInfo.remaining)}</span>
                    </div>
                    <div class="usage-detail">
                        <span class="usage-label">${this.chatManager.getLocalizedText('Daily Limit', 'Batas Harian')}</span>
                        <span class="usage-value">${this.formatNeuronsDisplay(limitInfo.daily_limit)}</span>
                    </div>
                </div>
            </div>
        `;
    }

    formatNeuronsDisplay(neurons) {
        if (neurons < 1000) {
            return neurons.toFixed(2) + ' neurons';
        } else if (neurons < 1000000) {
            return (neurons / 1000).toFixed(2) + 'k neurons';
        } else {
            return (neurons / 1000000).toFixed(4) + 'M neurons';
        }
    }
}

// Main Application
class QuranAIApp {
    constructor() {
        this.state = new AppState();
        this.dom = new DomElements();

        this.aiHandler = new AIResponseHandler(this.state, this.dom);

        this.chatManager = new ChatManager(this.state, this.dom, this.aiHandler);

        this.verseManager = new VerseManager(this.state, this.dom, this.chatManager);

        this.voiceManager = new VoiceManager(this.state, this.dom, this.chatManager);

        this.chatManager.setVerseManager(this.verseManager);

        this.aiHandler.setChatManager(this.chatManager);

        this.sendMessage = this.sendMessage.bind(this);
        this.toggleLanguage = this.toggleLanguage.bind(this);
        this.openOffcanvasMenu = this.openOffcanvasMenu.bind(this);
        this.closeOffcanvasMenu = this.closeOffcanvasMenu.bind(this);
        this.openOffcanvasVoice = this.openOffcanvasVoice.bind(this);
        this.closeOffcanvasVoice = this.closeOffcanvasVoice.bind(this);
        this.updateSendButtonState = this.updateSendButtonState.bind(this);
    }


    async init() {
        if (!this.dom.validate()) {
            console.error('Required DOM elements not found');
            return;
        }

        this.setupEventListeners();
        await this.loadInitialData();
        this.updateUI();
        
        // Check for existing ElevenLabs agent
        if (window.ustadAgent) {
            console.log('ElevenLabs agent detected');
        }
    }

    async loadInitialData() {
        // Load chat history
        this.chatManager.loadFromLocalStorage();
        
        // Load surah data
        await this.verseManager.loadSurahData();
        
        // Load existing chat if available
        if (this.state.chatHistory.length > 0) {
            this.chatManager.loadChat(this.state.chatHistory[0].id);
        }
    }

    updateUI() {
        // Update language UI
        this.dom.langLabel.textContent = Constants.SUPPORTED_LANGUAGES[this.state.currentLanguage];
        this.dom.languageToggle.checked = this.state.currentLanguage === 'en';
        
        // Update placeholder
        this.dom.messageInput.placeholder = this.chatManager.getLocalizedText(
            'Ask about the Quran...',
            'Tanyakan tentang Al-Quran...'
        );
        
        // Update welcome text
        const welcomeText = this.dom.welcomeState.querySelector('.welcome-text');
        if (welcomeText) {
            welcomeText.textContent = this.chatManager.getLocalizedText(
                'How can I help you regarding the Quran?',
                'Ada yang bisa saya bantu tentang Al-Quran?'
            );
        }
    }

    setupEventListeners() {
        // Message input events
        this.dom.sendBtn.addEventListener('click', this.sendMessage);
        
        this.dom.messageInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                this.sendMessage();
            }
        });
        
        this.dom.messageInput.addEventListener('input', () => {
            this.dom.messageInput.style.height = 'auto';
            this.dom.messageInput.style.height = `${this.dom.messageInput.scrollHeight}px`;
            this.updateSendButtonState();
        });
        
        // Sidebar events
        this.dom.menuIcon.addEventListener('click', this.openOffcanvasMenu);
        this.dom.offcanvasOverlay.addEventListener('click', this.closeOffcanvasMenu);
        if (this.dom.closeOffcanvas) {
            this.dom.closeOffcanvas.addEventListener('click', this.closeOffcanvasMenu);
        }
        
        this.dom.newChatBtn.addEventListener('click', () => {
            this.chatManager.createNewChat();
        });
        
        // Language toggle
        this.dom.languageToggle.addEventListener('change', this.toggleLanguage);
        
        // Verse selection events
        this.dom.selectVerseBtn.addEventListener('click', () => {
            this.verseManager.openActionSheet();
        });
        
        if (this.dom.waveBtn) {
            this.dom.waveBtn.addEventListener('click', () => {
                if (window.ustadAgent) {
                    // Use ElevenLabs Agent
                    window.ustadAgent.toggle();
                    
                    // Hide custom voice panel if open
                    this.closeOffcanvasVoice();
                } else {
                    // Fallback to custom voice recording
                    this.openOffcanvasVoice();
                }
            });
        }        
        
        if (this.dom.closeActionSheet) {
            this.dom.closeActionSheet.addEventListener('click', () => {
                this.verseManager.closeActionSheet();
            });
        }
        
        if (this.dom.actionSheetOverlay) {
            this.dom.actionSheetOverlay.addEventListener('click', () => {
                this.verseManager.closeActionSheet();
            });
        }
        
        if (this.dom.surahSelect) {
            this.dom.surahSelect.addEventListener('change', () => {
                this.verseManager.populateVerseSelect();
            });
        }
        
        if (this.dom.goVerseBtn) {
            this.dom.goVerseBtn.addEventListener('click', () => {
                this.verseManager.getSpecificVerse();
            });
        }
        
        // Voice events
        if (this.dom.waveBtn) {
            this.dom.waveBtn.addEventListener('click', () => {
                if (window.ustadAgent) {
                    window.ustadAgent.toggle();
                } else {
                    this.openOffcanvasVoice();
                }
            });
        }
        
        if (this.dom.closeOffcanvasVoice) {
            this.dom.closeOffcanvasVoice.addEventListener('click', this.closeOffcanvasVoice);
        }
        
        if (this.dom.voiceOffcanvasOverlay) {
            this.dom.voiceOffcanvasOverlay.addEventListener('click', this.closeOffcanvasVoice);
        }
        
        if (this.dom.startRecordingBtn) {
            this.dom.startRecordingBtn.addEventListener('click', () => {
                this.voiceManager.startRecording();
            });
        }
        
        if (this.dom.stopRecordingBtn) {
            this.dom.stopRecordingBtn.addEventListener('click', () => {
                this.voiceManager.stopRecording();
            });
        }
    }

    async sendMessage() {
        const userMessage = this.dom.messageInput.value.trim();
        if (!userMessage) return;

        // Clear input and update UI
        this.dom.messageInput.value = '';
        this.dom.messageInput.style.height = 'auto';
        this.updateSendButtonState();

        // Add user message to chat
        this.chatManager.appendUserMessage(userMessage);

        // Handle first message
        if (this.state.isFirstMessage) {
            this.chatManager.hideWelcomeState();
            this.state.isFirstMessage = false;
            if (this.state.currentChatId === null) {
                this.chatManager.createNewChat(false);
            }
        }

        // Show typing indicator
        const typingEl = this.chatManager.showTypingIndicator();

        try {
            // Send to AI API
            const response = await ApiService.sendQuestion(userMessage, this.state.currentLanguage);
            typingEl.remove();
            
            // Display response
            this.aiHandler.displayBackendAIResponse(userMessage, response, true);
            
        } catch (error) {
            typingEl.remove();
            this.chatManager.showError(
                this.chatManager.getLocalizedText(
                    'An error occurred while processing the response. Please try again.',
                    'Terjadi kesalahan saat memproses respons. Silakan coba lagi.'
                )
            );
        }
    }

    toggleLanguage() {
        const newLanguage = this.dom.languageToggle.checked ? 'en' : 'id';
        
        if (this.state.setLanguage(newLanguage)) {
            this.updateUI();
            this.chatManager.renderChatHistory();
            
            // Update existing chat if loaded
            if (this.state.currentChatId) {
                const currentChat = this.state.chatHistory.find(c => c.id === this.state.currentChatId);
                if (currentChat) {
                    this.chatManager.updateChatTitle(currentChat.title);
                }
            }
        }
    }

    updateSendButtonState() {
        const hasText = this.dom.messageInput.value.trim().length > 0;
        
        if (hasText) {
            this.dom.sendBtn.classList.add('visible');
            if (this.dom.waveBtn) {
                this.dom.waveBtn.classList.add('hidden');
            }
        } else {
            this.dom.sendBtn.classList.remove('visible');
            if (this.dom.waveBtn) {
                this.dom.waveBtn.classList.remove('hidden');
            }
        }
    }

    openOffcanvasMenu() {
        this.dom.offcanvasOverlay.classList.add('active');
        this.dom.offcanvasSidebar.classList.add('active');
        this.dom.menuIcon.classList.add('active');
        document.body.style.overflow = 'hidden';
    }

    closeOffcanvasMenu() {
        this.dom.offcanvasOverlay.classList.remove('active');
        this.dom.offcanvasSidebar.classList.remove('active');
        this.dom.menuIcon.classList.remove('active');
        document.body.style.overflow = '';
    }

    openOffcanvasVoice() {
        this.voiceManager.openVoicePanel();
    }

    closeOffcanvasVoice() {
        this.voiceManager.closeVoicePanel();
    }

    checkElevenLabsStatus() {
            const waveBtn = this.dom.waveBtn;
            if (!waveBtn) return;
            
            const statusSpan = waveBtn.querySelector('.voice-status');
            if (statusSpan) {
                if (window.ustadAgent) {
                    statusSpan.textContent = 'AI';
                    statusSpan.style.color = '#4285f4';
                    waveBtn.title = 'ElevenLabs Voice Assistant (Klik untuk berbicara)';
                } else {
                    statusSpan.textContent = '';
                    statusSpan.style.color = '#34a853';
                    waveBtn.title = 'Voice Recording (Custom)';
                }
            }
        }

    async init() {
        if (!this.dom.validate()) {
            console.error('Required DOM elements not found');
            return;
        }

        this.setupEventListeners();
        await this.loadInitialData();
        this.updateUI();
        this.checkElevenLabsStatus(); // Check status
        
        // Check again after a delay (in case widget loads async)
        setTimeout(() => this.checkElevenLabsStatus(), 2000);
    }
}

// Initialize application when DOM is ready
document.addEventListener('DOMContentLoaded', () => {
    const app = new QuranAIApp();
    window.quranAIApp = app;
    app.init();
});

document.addEventListener('DOMContentLoaded', function() {
    if (window.lucide) {
        lucide.createIcons();
    }
    document.getElementById('waveBtn')?.addEventListener('click', function() {
        setTimeout(() => {
            if (window.lucide) {
                lucide.createIcons();
            }
        }, 300);
    });
});
</script>

    <div id="elevenlabs-agent-container"></div>
    <script src="https://elevenlabs.io/agent-widget/index.js" defer></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Initialize ElevenLabs Agent
            const agentOptions = {
                agentId: "agent_1801kbypkmmqefn8z5zvzk508b70",
                voice: {
                    voiceId: "21m00Tcm4TlvDq8ikWAM",
                    modelId: "eleven_multilingual_v2",
                    settings: {
                        stability: 0.5,
                        similarity_boost: 0.8
                    }
                },
                ui: {
                    customTheme: {
                        primaryColor: "#4285f4",
                        backgroundColor: "#1e1f20",
                        textColor: "#ffffff"
                    }
                },
                tools: {
                    webhooks: [
                        {
                            name: "quran-ai-assistant-webhook",
                            description: "AI assistant khusus untuk pertanyaan seputar Al-Quran",
                            api_schema: {
                                url: "https://ai-quran-workers.harisudahmalam.workers.dev/api/elevenhook",
                                method: "POST",
                                request_body_schema: {
                                    id: "quran_ai_request",
                                    type: "object",
                                    description: "Request body for Quran AI Assistant",
                                    required: true,
                                    properties: [
                                        {
                                            id: "input",
                                            type: "string",
                                            description: "Pertanyaan dari pengguna",
                                            required: true,
                                            dynamic_variable: "",
                                            constant_value: ""
                                        },
                                        {
                                            id: "session_id",
                                            type: "string",
                                            description: "Session ID percakapan",
                                            required: false,
                                            dynamic_variable: "",
                                            constant_value: ""
                                        },
                                        {
                                            id: "variables",
                                            type: "object",
                                            description: "Variables context",
                                            required: false,
                                            dynamic_variable: "",
                                            constant_value: "",
                                            properties: [
                                                {
                                                    id: "example_key",
                                                    type: "string",
                                                    description: "Example property for object type",
                                                    required: false,
                                                    dynamic_variable: "",
                                                    constant_value: ""
                                                }
                                            ]
                                        },
                                        {
                                            id: "tool_calls",
                                            type: "array",
                                            description: "Tool calls array",
                                            required: false,
                                            dynamic_variable: "",
                                            constant_value: "",
                                            items: {
                                                type: "object",
                                                description: "Tool call item",
                                                required: false,
                                                properties: [
                                                    {
                                                        id: "tool_id",
                                                        type: "string",
                                                        description: "ID of the tool",
                                                        required: false,
                                                        dynamic_variable: "",
                                                        constant_value: ""
                                                    }
                                                ]
                                            }
                                        }
                                    ]
                                }
                            }
                        }
                    ]
                }
            };
            const agent = new window.ElevenLabs.Agent(agentOptions);
            window.ustadAgent = agent;
            const waveBtn = document.getElementById('waveBtn');
            if (waveBtn) {
                waveBtn.addEventListener('click', function() {
                    agent.toggle();
                });
            }
            agent.on('speaking', function() {
                console.log('Agent sedang berbicara');
            });
    
            agent.on('listening', function() {
                console.log('Agent sedang mendengarkan');
            });
    
            agent.on('error', function(error) {
                console.error('Agent error:', error);
            });
        });
    </script>
    </body>
</html>